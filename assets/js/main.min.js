let selectedDesign=null,selectedImageSrc=null,designSwiper,textSwiper,certificateValue=0,nominalValue=0;const inputs={design:document.getElementById("designInput"),text:document.getElementById("textCardInput"),price:document.getElementById("priceInput"),senderName:document.getElementById("senderName"),senderEmail:document.getElementById("senderEmail"),senderCity:document.getElementById("senderCity"),senderReceivingTypeStudio:document.getElementById("receivingStudio"),senderReceivingTypeEmail:document.getElementById("receivingEmail"),recipientName:document.getElementById("recipientName"),recipientPhone:document.getElementById("recipientPhone"),recipientCity:document.getElementById("recipientCity")},initPhoneMask=e=>{let t="+7 (";e.addEventListener("focus",()=>{e.value===t&&(e.value=""),""===e.value&&(e.value=t)}),e.addEventListener("blur",()=>{(""===e.value.trim()||e.value===t)&&(e.value="")}),e.addEventListener("input",e=>{let t=e.target.value.replace(/\D/g,""),i="";t.length>0&&(i="+7 ("+t.substring(1,4)),t.length>4&&(i+=") "+t.substring(4,7)),t.length>7&&(i+="-"+t.substring(7,9)),t.length>9&&(i+="-"+t.substring(9,11)),e.target.value=i})},initDesignSwiper=()=>{console.log("инитсвипер"),designSwiper&&(designSwiper.destroy(!0,!0),console.log("дестрой")),(designSwiper=new Swiper(".design__swiper",{direction:"horizontal",slidesPerView:1,spaceBetween:7,initialSlide:1,pagination:{el:".design__swiper-paginaton"},navigation:{nextEl:".design__swiper-button-next",prevEl:".design__swiper-button-prev"},on:{slideChangeTransitionEnd:selectDesign}})).slideTo(sessionStorage.getItem("activeSlideIndex")-1||0,0),console.log("сохранённый индекс:",sessionStorage.getItem("activeSlideIndex")),selectDesign()},selectDesign=()=>{let e=document.querySelector(".design__swiper-slide.swiper-slide-active"),t=e.getAttribute("data-design"),i=document.getElementById("designInput");i.value=t;let n=e.querySelector(".design__slide-img");selectedImageSrc=n.src,console.log("Сохраненный дизайн:",i.value,"Сохраненная картинка:",selectedImageSrc),sessionStorage.setItem("activeSlideIndex",t),console.log("сохранённый индекс:",sessionStorage.getItem("activeSlideIndex"));let a=document.querySelector(".text-page__card-title");1==t?a.style.color="#4C4B4B":a.style.color=""},initTextSwiper=()=>{console.log("инит textSwiper"),textSwiper&&(textSwiper.destroy(!0,!0),console.log("textSwiper уничтожен")),(textSwiper=new Swiper(".text-page__swiper",{direction:"horizontal",slidesPerView:1,spaceBetween:20,pagination:{el:".text-page__swiper-pagination"},navigation:{nextEl:".text-page__swiper-button-next",prevEl:".text-page__swiper-button-prev"},on:{slideChangeTransitionEnd:selectText}})).slideTo(sessionStorage.getItem("activeTextSlideIndex")||1,0),console.log("сохранённый индекс текста:",sessionStorage.getItem("activeTextSlideIndex")),selectText()},selectText=()=>{let e=document.querySelector(".text-page__swiper-slide.swiper-slide-active"),t=e.querySelector(".text-page__slide-text").textContent.trim(),i=document.getElementById("textCardInput");i.value=t;let n=document.querySelector(".text-page__card-title");n.textContent=t,console.log("Сохраненный текст:",t),sessionStorage.setItem("activeTextSlideIndex",textSwiper.realIndex),console.log("сохранённый индекс текста:",sessionStorage.getItem("activeTextSlideIndex"))};function checkCheckboxes(){inputs.senderReceivingTypeStudio.checked||inputs.senderReceivingTypeEmail.checked?(document.querySelector(".data-page-one__checkbox-error").style.display="none",inputs.senderReceivingTypeStudio.parentElement.classList.remove("invalid"),inputs.senderReceivingTypeEmail.parentElement.classList.remove("invalid")):(document.querySelector(".data-page-one__checkbox-error").innerHTML="Не выбран способ получения сертификата!",document.querySelector(".data-page-one__checkbox-error").style.display="block",inputs.senderReceivingTypeStudio.parentElement.classList.add("invalid"),inputs.senderReceivingTypeEmail.parentElement.classList.add("invalid"))}document.addEventListener("DOMContentLoaded",function(){let e=document.querySelector(".main-page"),t=document.querySelector(".inner-page"),i=document.querySelector(".loading-page"),n=document.querySelector(".final-page"),a=document.querySelector(".main-page__button"),l=t.querySelector(".next-button"),r=t.querySelector(".back-button"),s=t.querySelectorAll(".inner-page__content > div"),d=document.querySelector(".inner-page__title"),c={"design-page":"Выбери оформление","text-page":"Выбери текст","amount-page":"Выбери номинал","data-page-one":"Введите данные","data-page-two":"Введите данные"},o={main:"linear-gradient(155deg, #181818 17%, #9B68BF)",final:"linear-gradient(180deg, #181818 18%, #9B68BF)",default:"#181818"};function p(e){let t=document.querySelector(".wrapper");t&&(t.style.background=o[e]||o.default)}let u=sessionStorage.getItem("currentStep")||0;function g(e){if(s.forEach(e=>e.style.display="none"),e.style.display="flex",d.textContent=c[e.classList[0]],e.classList.contains("main-page")?p("main"):e.classList.contains("final-page")?p("final"):p("default"),e.classList.contains("text-page")){console.log(sessionStorage.getItem("activeSlideIndex"));let t=e.querySelector(".text-page__card-img");selectedImageSrc&&(t.src=selectedImageSrc),initTextSwiper()}if(e.classList.contains("amount-page")&&function e(){let t=document.querySelectorAll(".amount-page__price-button"),i=document.getElementById("priceInput"),n;if(sessionStorage.getItem("certificateValue")){let a=sessionStorage.getItem("certificateValue");m(a);let l=document.querySelectorAll(".amount-page__price-button");l.forEach(e=>{e.getAttribute("data-price")===a?e.classList.add("active"):e.classList.remove("active")})}else m(t[0].getAttribute("data-price")),t[0].classList.add("active");t.forEach(e=>{e.addEventListener("click",function(){t.forEach(e=>e.classList.remove("active")),e.classList.add("active"),n=e.getAttribute("data-price"),console.log(i.value),m(n)})})}(),e.classList.contains("data-page-one")){for(let i in function e(){let t=document.querySelector(".data-page-one__form");function i(){y.senderName=t.querySelector("#senderName").value,y.senderEmail=t.querySelector("#senderEmail").value,y.senderCity=t.querySelector("#senderCity").value,y.senderReceivingTypeStudio=inputs.senderReceivingTypeStudio.checked,y.senderReceivingTypeEmail=inputs.senderReceivingTypeEmail.checked,sessionStorage.setItem("senderFormData",JSON.stringify(y))}t.addEventListener("input",function(e){("senderName"===e.target.id||"senderEmail"===e.target.id)&&i()}),t.addEventListener("change",function(e){("senderCity"===e.target.id||"senderReceivingTypeStudio"===e.target.name||"senderReceivingTypeEmail"===e.target.name)&&i()}),function e(){let i=sessionStorage.getItem("senderFormData");i&&(y=JSON.parse(i),t.querySelector("#senderName").value=y.senderName,t.querySelector("#senderEmail").value=y.senderEmail,t.querySelector("#senderCity").value=y.senderCity,inputs.senderReceivingTypeStudio.checked=y.senderReceivingTypeStudio||!1,inputs.senderReceivingTypeEmail.checked=y.senderReceivingTypeEmail||!1)}()}(),inputs){let n=inputs[i];n&&n.addEventListener("input",()=>{validateField(n)})}inputs.senderReceivingTypeStudio.addEventListener("change",checkCheckboxes),inputs.senderReceivingTypeEmail.addEventListener("change",checkCheckboxes)}if(e.classList.contains("data-page-two")){for(let a in function e(){let t=document.querySelector(".data-page-two__form");function i(){v.recipientName=t.querySelector("#recipientName").value,v.recipientPhone=t.querySelector("#recipientPhone").value,v.recipientCity=t.querySelector("#recipientCity").value,sessionStorage.setItem("recipientFormData",JSON.stringify(v))}t.addEventListener("input",function(e){("recipientName"===e.target.id||"recipientPhone"===e.target.id)&&i()}),t.addEventListener("change",function(e){"recipientCity"===e.target.id&&i()}),function e(){let i=sessionStorage.getItem("recipientFormData");i&&(v=JSON.parse(i),t.querySelector("#recipientName").value=v.recipientName,t.querySelector("#recipientPhone").value=v.recipientPhone,t.querySelector("#recipientCity").value=v.recipientCity)}()}(),console.log(v),inputs){let l=inputs[a];l&&l.addEventListener("input",()=>{validateField(l)})}let r=document.getElementById("recipientPhone");r&&initPhoneMask(r)}}function m(e){let t={5:2,5e3:2e3,7e3:3e3,1e4:5e3}[e];certificateValue=+e,nominalValue=+e+t,priceInput.value=nominalValue,sessionStorage.setItem("priceValue",priceInput.value),document.getElementById("certificate-value").textContent=`${formatNumber(certificateValue)}₽`,document.getElementById("bonuses-value").textContent=`+${formatNumber(t)}₽`,document.getElementById("your-certificate-value").textContent=`${formatNumber(nominalValue)}₽`,document.getElementById("total-value").textContent=`${formatNumber(certificateValue)}₽`,sessionStorage.setItem("certificateValue",certificateValue),sessionStorage.setItem("nominalValue",nominalValue)}console.log(u),a.addEventListener("click",function(){e.style.display="none",t.style.display="block",g(s[0]),initDesignSwiper(),u=0,sessionStorage.setItem("currentStep",u)}),l.addEventListener("click",function(){if(u<s.length-1)(3!==u||validateSenderFields())&&(g(s[++u]),sessionStorage.setItem("currentStep",u),console.log(u));else{if(console.log(validateRecipientFields()),!validateRecipientFields())return;t.style.display="none",i.style.display="block",fillFinalForm(),setTimeout(()=>{i.style.display="none",n.style.display="block",p("final")},2e3)}}),r.addEventListener("click",function(){if(u>0){if(g(s[--u]),console.log(u),0===u)designSwiper.slideTo(sessionStorage.getItem("activeSlideIndex")-1||0,0),console.log("переход к слайду(назад):",sessionStorage.getItem("activeSlideIndex"));else if(2===u){let i=sessionStorage.getItem("certificateValue");console.log(1,i),m(i);let n=document.querySelectorAll(".amount-page__price-button");n.forEach(e=>{e.getAttribute("data-price")===i?e.classList.add("active"):e.classList.remove("active")})}}else t.style.display="none",e.style.display="flex",sessionStorage.clear(),p("main")});let y={senderName:"",senderEmail:"",senderCity:"",senderReceivingTypeStudio:"",senderReceivingTypeEmail:""},v={recipientName:"",recipientPhone:"",recipientCity:""}});const fillFinalForm=()=>{let e=document.querySelector(".uc-form");if(!e){console.error("Финальная форма не найдена");return}let t=e=>e.charAt(0).toUpperCase()+e.slice(1);for(let i in inputs){let n=e.querySelector(`[name="final${t(i)}"]`);console.log(n,inputs[i].value),"senderReceivingTypeStudio"===i||"senderReceivingTypeEmail"===i?(n.checked=inputs[i].checked,n.value=!!inputs[i].checked,console.log(inputs[i].checked)):n&&(n.value=inputs[i].value)}let a=document.querySelector(".final-page__card");if(a){let l=a.querySelector(".final-page__card-img"),r=a.querySelector(".final-page__card-title"),s=a.querySelectorAll(".final-page__card-price");"1"==inputs.design.value&&(r.style.color="#4C4B4B"),l&&(l.src=selectedImageSrc||"./assets/images/design-page/slide-img-2.png"),r&&(r.textContent=inputs.text.value||"");let d=sessionStorage.getItem("nominalValue")||0;console.log(d,sessionStorage.getItem("nominalValue")),s.forEach(e=>{let t=e.getAttribute("data-nominal");d==t?e.style.display="block":e.style.display="none"})}let c=document.querySelector(".final-page__button");if(c){let o=sessionStorage.getItem("certificateValue")||0,p=sessionStorage.getItem("nominalValue")||0,u=`#order:Сертификат ${p}=${o}`;c.setAttribute("href",u),console.log(c)}console.log("Значения успешно подставлены в финальную форму")},formatNumber=e=>e.toString().replace(/\B(?=(\d{3})+(?!\d))/g," "),validateSenderFields=()=>{let e=!0,t={senderName:inputs.senderName,senderEmail:inputs.senderEmail,senderCity:inputs.senderCity,senderReceivingTypeStudio:inputs.senderReceivingTypeStudio,senderReceivingTypeEmail:inputs.senderReceivingTypeEmail};for(let i in t){let n=t[i];n&&!validateField(n)&&(e=!1)}return inputs.senderReceivingTypeStudio.checked||inputs.senderReceivingTypeEmail.checked?(document.querySelector(".data-page-one__checkbox-error").style.display="none",inputs.senderReceivingTypeStudio.parentElement.classList.remove("invalid"),inputs.senderReceivingTypeEmail.parentElement.classList.remove("invalid")):(document.querySelector(".data-page-one__checkbox-error").innerHTML="Не выбран способ получения сертификата!",e=!1,document.querySelector(".data-page-one__checkbox-error").style.display="block",inputs.senderReceivingTypeStudio.parentElement.classList.add("invalid"),inputs.senderReceivingTypeEmail.parentElement.classList.add("invalid")),e},validateRecipientFields=()=>{let e=!0,t={recipientName:inputs.recipientName,recipientPhone:inputs.recipientPhone,recipientCity:inputs.recipientCity};for(let i in t){let n=t[i];n&&!validateField(n)&&(e=!1)}return e},validateField=e=>{let t=e.value.trim(),i=!0;return e.classList.remove("invalid"),""===t&&(i=!1),("senderName"===e.id||"recipientName"===e.id)&&/\d/.test(t)&&(i=!1),"senderEmail"!==e.id||/@/.test(t)&&t.includes(".")&&0!==t.indexOf("@")&&t.indexOf("@")!==t.length-1||(i=!1),"recipientPhone"===e.id&&""===t&&(i=!1),e.dataset.originalPlaceholder=e.placeholder,i?(e.dataset.placeholderChanged=!1,e.placeholder=e.dataset.originalPlaceholder||e.placeholder):(e.classList.add("invalid"),e.dataset.placeholderChanged||(e.placeholder+=" (обязательно)",e.dataset.placeholderChanged=!0)),i};window.addEventListener("beforeunload",function(){sessionStorage.clear()});